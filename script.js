const chat=document.getElementById('chat');const form=document.getElementById('form');const input=document.getElementById('msg');const btn=document.getElementById('sendBtn');const history=[];
function bubble(t,who='user'){const d=document.createElement('div');d.className=`bubble ${who==='ai'?'ai':'user'}`;d.textContent=t;chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
function typing(on){let t=document.getElementById('typing');if(on){if(t)return;t=document.createElement('div');t.id='typing';t.className='bubble ai';t.textContent='…';chat.appendChild(t)}else{if(t)t.remove()}chat.scrollTop=chat.scrollHeight;}
async function ask(text){try{btn.disabled=true;bubble(text,'user');history.push({role:'user',content:text});input.value='';const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,history})});if(!r.ok)throw new Error(await r.text());const data=await r.json();const reply=data.reply||'…';bubble(reply,'ai');history.push({role:'assistant',content:reply});}catch(e){bubble('Sorry, I could not reply. Try again.','ai')}finally{btn.disabled=false;input.focus()}}form.addEventListener('submit',e=>{e.preventDefault();const t=input.value.trim();if(t)ask(t)});document.getElementById('reset').addEventListener('click',e=>{e.preventDefault();chat.innerHTML='';bubble('Hi, I’m Anima — a gentle friend and CBT-informed coach. How are you feeling today?','ai');history.length=0;window.scrollTo({top:0,behavior:'smooth'})});